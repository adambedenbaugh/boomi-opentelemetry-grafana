livedebugging {
  enabled = true
}

otelcol.receiver.otlp "default" {
  grpc { endpoint = "0.0.0.0:4317" }
  http { endpoint = "0.0.0.0:4318" }

  output {
                logs    = [otelcol.exporter.loki.to_loki.input]
                metrics = [otelcol.exporter.prometheus.to_prom.input]
                traces  = [otelcol.processor.batch.traces.input]
        }
}

prometheus.remote_write "prom" {
  endpoint {
        url = "http://" + sys.env("PROMETHEUS_HOSTNAME") + ":9089/api/v1/write"
  }
}

otelcol.exporter.prometheus "to_prom" {
        forward_to = [prometheus.remote_write.prom.receiver]
}


loki.write "grafana_loki" {
  endpoint{
        url  = "http://" + sys.env("LOKI_HOSTNAME") + ":3100/loki/api/v1/push"
  }
}

otelcol.exporter.loki "to_loki" {
        forward_to = [loki.write.grafana_loki.receiver]
}

otelcol.processor.batch "traces" {
        output {
                traces = [otelcol.exporter.otlp.tempo.input]
        }
}


otelcol.exporter.otlp "tempo" {
        client {
                endpoint = sys.env("TEMPO_HOSTNAME") + ":4317"
                tls {insecure = true}
        }
}


pyroscope.receive_http "default" {
  http {
    listen_address = "0.0.0.0"
    listen_port    = 4040
  }
  forward_to = [pyroscope.write.grafana.receiver]
}

pyroscope.write "grafana" {
  endpoint {
    url = "http://" + sys.env("PYROSCOPE_HOSTNAME") + ":4040"
  }
}

// Node/System metrics collection using node_exporter
prometheus.exporter.unix "system_metrics" {
  include_exporter_metrics = true
  disable_collectors       = ["mdadm"]
}

prometheus.scrape "system_metrics" {
  targets = prometheus.exporter.unix.system_metrics.targets
  forward_to = [prometheus.remote_write.prom.receiver]
  scrape_interval = "15s"
  
  // Add labels to identify the host
  job_name = "node-exporter"
}

// Docker container metrics (if running on Docker host)
prometheus.exporter.cadvisor "container_metrics" {
  docker_host = "unix:///var/run/docker.sock"
}

prometheus.scrape "container_metrics" {
  targets = prometheus.exporter.cadvisor.container_metrics.targets
  forward_to = [prometheus.remote_write.prom.receiver]
  scrape_interval = "15s"
  job_name = "cadvisor"
}